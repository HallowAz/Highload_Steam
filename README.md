# Курсовая работа. Проект - Steam

## Тема и целевая аудитория

В качестве высоконагруженной системы был выбран онлайн-сервис цифрового распростронения компьютерных игр и программ - Steam.

### Целевая Аудитория

#### Распределение по возрасту:

Даннные со [statista](https://www.statista.com/forecasts/1242344/steam-us-user-share-by-age) сообщают о следующем распределении по возрасту в США:


| Возраст, лет| %  |
|-------------|----|
| 18-19       | 6  |
| 20-29       | 32 |
| 30-39       | 35 |
| 40-49       | 18 |
| 50-59       | 7  |
| 60-64       | 2  |

Можно принять то, что в остальных странах показатели схожи. Но стоит учитывать, то что несовершеннолетние пользователи намеренно меняют возраст, чтобы получить доступ к играм с возрастным ограничением. Учитывая этот факт, можно считать целевую аудиторию, начиная с 10 и до 50 лет.

Тот же источник ([statista](https://www.statista.com/forecasts/1242343/steam-us-user-share-by-gender)) сообщает о соотношении полов среди пользователей.
- Мужской - 68%
- Женский - 32%

Таким образом, можно сделать вывод о том, что средний пользователь Steam - это __мужчина около 30 лет__.

### Активность пользователей

В день: ≈ 25 млн активных пользователей

В месяц: ≈ 130 млн активных пользователей

Данные взяты с [steamdb](https://steamdb.info/app/753/charts/#1m) и [backlinko](https://backlinko.com/steam-users#:~:text=Steam%20has%20120%20million%20monthly,Steam%20on%20a%20daily%20basis.\\)

После математических рассчётов количества пользователей в разных странах, их соотношения относительно друг друга и пропорционального распределения относительно месячной активности, было получено:

- США - 16.7 млн
- Китай - 14 млн
- Россия - 11.6 млн
- Бразилия - 6 млн
- Германия - 4.4 млн
- Канада - 3.67 млн
- Турция - 3.42 млн
- Франция - 3.42 млн
- Великобритания - 3.18 млн
- Польша - 2.93 млн
- Филиппины - 2.57 млн
- Украина - 2.44 млн
- Япония - 1.95 млн
- Южная Корея - 1.83 млн
- Индонезия - 1.71 млн
- Австралия - 1.71 млн
- Аргентина - 1.59 млн
- Таиланд - 1.47 млн
- Испания - 1.47 млн
- Италия - 1.34 млн
- Румыния - 1.22 млн
- Мексика - 1.22 млн
- Чили  - 1.22 млн
- Индия - 1.18 млн
- Швеция - 1.16 млн
- Перу - 1 млн

Итого выходит MAU по континентам:
- Северная Америка - 21.59 млн 
- Европа - 29.68 млн
- Азия - 31.61 млн
- Южная Америка - 9.81 млн
- Австралия - 1.59 млн

Данные стран, где пользователей меньше 1 млн в месяц не учитывались. Также стоит отметить, что в России 70% населения живут в европейской части страны, а 30% в азиатской. Было решено распределить пропорционально и самих пользователей.

Количество пользователей было взято из [worldpopulationview](https://worldpopulationreview.com/country-rankings/steam-users-by-country) 

### Функционал 

- Скачивание файлов игр с серверов Steam
- Нагрузки страниц игр
- Транзакции, связяанные с покупкой игр и операциями с банками
- Микротранзакции внутри игры, где Steam выступает посредником
- Рейтинг игр во внутреннем магазине

## Расчёт нагрузки

Расчёт нагрузки будет осуществлён отдельно для каждого необходимого пути API.

### Расчёты 

Как уже было сказано выше, данный об активных пользователях следующие:
- MAU - 130 млн
- DAU - 25 млн

Размер хранилища пользователя довольно невелик. В него включён список игр, количество часов в этих играх, дата последнего запуска каждой игры, список достижений, список друзей, аватар, 10 последних никнеймов и скриншоты.

Но размер этих данных несущественен по сравнению с тем фактом, что steam выделяет 1 ГБ на каждого пользователя для хранения его данных, скриншотов и некоторых настроек игр [источник](https://support.sega.com/hc/en-us/articles/9998624966161-How-much-space-does-my-Cloud-have-for-Football-Manager-files#:~:text=Steam%20allows%201GB%20of%20Cloud,use%20the%20Cloud%20Save%20Settings.). Выходит что размер хранилища на одного пользователя равен 1 ГБ.

#### Расчёт RPS

Поскольку найти количество скачиваемых игр в месяц не удалось, будем считать, что оно примерно равно среднему количеству покупок игр в месяц. Среднее количество покупок единиц игр в месяц равно 34.11 млн. Данные были взяты с сайта [statista](https://www.statista.com/statistics/1333058/steam-game-sales-units/#:~:text=Steam%20annual%20game%20units%20sold%202020%2D2028&text=First%20released%20in%202003%20by,platform%20(excluding%20free%20downloads).).

RPS на скачивание выходит  около 13. Однако стоит учитывать, что скачивание игр значительно отличается от обычного запроса. В данном случае упор делается на время, которое сервер выделяет для каждого пользователя. Оно зависит от интернет-соединения пользователя, а также от размера игры. Приняв тот факт, что игры скачивают почти всегда на постоянном интернете, скоростью около 100Мбит/с и средний размер игры, равный 15 ГБ ([источник](https://arstechnica.com/gaming/2013/09/is-downloadable-game-size-increasing-faster-than-broadband-speeds/#:~:text=On%20Steam%2C%20the%20average%20download,in%202007%20to%2015GB%20today.)).

Получим t = 15 * 1024 * 1024 * 8 / (100 * 1024) = 1228.8 секунд. t - среднее количество времени, которое сервер Steam удерживает соединение и отправляет данные одному пользователю. 

RPS страницы игры. Будем высчитывать с помощью количества покупок. Известно, что коэффициент конверсии страницы игры (т.е. процент купленных игр относительно просмотра страницы) равен 6% для средней игры ([источник](https://www.gamesindustry.biz/dude-wheres-my-money-part-one-the-science-of-steam)).  

Следовательно, RPS = 34.11 млн / 0.06 / (30 * 86400) + 13 = 232.
Число 13 добавилось из учёта того, что 6% пользователей продолжают взаимодействие со страницей для покупки игры. Также стоит учесть, что 4 раза в год случаются распродажи, которые будут значительно увеличивать RPS на весь период распродаж. Количество просмотров в месяц отсюда же 568.5 млн.

RPS покупки игры опирался на [данное видео](https://www.youtube.com/watch?v=YJrWm83gVfw&ab_channel=GuideRealm), где показывается процесс покупки игры, который занимает, как минимум 5 запросов от каждого пользователя. Если брать данные о количестве покупок в месяц, то RPS = 34.11 млн * 5 / (30 * 86400) = 66. Тут также стоит учесть тот факт, что серверу необходимо дождаться результатов транзакции от банка, а также создать свою транзакцию и в случае ошибки на одном из этапов полностью откатить её и начать заново, иначе пользователь или Steam могут потерять деньги.

RPS пользования торговой площадкой Steam, которая также является посредником во внутриигровых микротранзакциях, вычислялся с помощью [данного видео](https://www.youtube.com/watch?v=pbzH4tTDyD0&ab_channel=Titan), которое показало, что для оформления покупки необходимо, как минимум 4 запроса. А также [данная статья](https://www.worldpay.com/en/insights/article/from-gaming-to-the-mainstream-are-microtransactions-here-to-stay), в которой говорится, что 41% пользвателей совершает как минимум одну внутригровую покупку в неделю. Для учёта тех, кто покупает больше, будем считать 1.5. Число запросов тороговой площадки для просмотра будем учитывать также из коэффициент конверсии, указанного выше (другой информации не было найдено). Также стоит учесть, что постоянно идёт выкладывание новых товаров на продажу, что также создаёт нагрузку. Будем считать количество этих выкладываний примерно равным покупкам. [Данное видео](https://www.youtube.com/watch?v=LYSbRrM_QIk&ab_channel=Titan) показывает, что для продажи предмета необходимо сделать 2 запроса. Итого получается С = 132млн * 1.5 / (7 * 30 * 86400) = 11, где C - количество покупок в секунду. RPS = 11 * 4 + 11 / 0.06 + 11 * 2 = 250. Здесь были сложены запросы за покупку, за просмотры и за выставление на продажу товаров. Стоит также учитывать, что как и в случае с покупкой игры, в данном случае необходимо соблюдать транзакционность и ждать ответа банка. В случае ошибки необходимо всё откатить и начать заново. Из сказанного выше количество покупок и продаж в месяц, т.е. единиц действия микротранзакций будет равно 57 млн.

RPS рейтинга рассчитывался на основе [данной статьи](https://app2top.ru/marketing/pochemu-pervy-e-10-otzy-vov-v-steam-samy-e-vazhny-e-dlya-vidimosti-igry-195815.html#:~:text=%D0%92%20%D1%81%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%BC%20%D0%BE%D0%B4%D0%B8%D0%BD%20%D0%BE%D1%82%D0%B7%D1%8B%D0%B2%20%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D1%82,%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F%D0%BC%20%D0%B2%20%D0%BE%D0%B1%D0%BC%D0%B5%D0%BD%20%D0%BD%D0%B0%20%D0%BE%D1%82%D0%B7%D1%8B%D0%B2%D1%8B.), где говорится, что оценку делает каждый 30-й покупатель. При этом необходимо учесть, что за оценками идёт запрос при каждой загрузке страницы игры. итого получается RPS = 34.11 млн / 0.06 / (30 * 86400) + 34.11 млн / 30 / (30 * 86400) = 220. Из сказанного выше, количество просмотра и рейтинга и оценивания игр будет равно 35.25 млн.

### Продуктовые метрики 

| Метрика                                    | Значение      |
|--------------------------------------------|---------------|
| MAU                                        | 132 млн       |
| DAU                                        | 25 млн        |
| Скачивание игр                             | 34.11 млн/мес |
| Посещение страницы игры                    | 568.5 млн/мес |
| Покупка игр                                | 34.11 млн/мес |
| Микротранзакции в играх, покупки и продажи | 57 млн/мес    |
| Рейтинг, просмотр и  оценивание            | 35.25 млн/мес |


### Технические метрики

Количество игр в Steam равно 50046, [источник](https://earthweb.com/how-many-games-are-on-steam/#:~:text=As%20of%20the%20latest%20inventory,simulation%2C%20sports%2C%20and%20strategy.). Из источников выше можно также узнать, что в 2007 средний объём игр был равен 4 ГБ, а в 2023 - 15ГБ. Возьмём среднее значение - 10 ГБ для каждой игры. Итого выходит, что только для хранения файлов игры необходимо 500.46 ТБ. Каждому пользователю также необходим 1 ГБ памяти, как было сказано выше. [Данный источник](https://www.tomshardware.com/news/valve-steam-number-accounts-users-billion,39228.html#:~:text=More%20than%201%20billion%20Steam,exactly%20popping%20the%20champagne%2C%20however.) сообщает, что в Steam около 1 млрд аккаунтов, для каждого из которых выделен 1 ГБ памяти, т.е. для их хранения необходимо около 950 ПБ.

Остальной функционал не требует хранилищ таких объёмов.

Рассчитаем сетевой трафик. 

**Скачивание**: Как было указано выше, длительность скачивания при скорости 100 Мбит/с равна примерно 1228.8 сек.
RPS на скачивание игры равен 13, а значит каждую секунду 13 новых человек начинают скачивание. Из этого выходит, что 13 * 100 * 1228.8 = 1.6Тб/сек - потребление трафика на скачивание игр. 

**Страница игры**: По результатам открытия нескольких страниц с карточками игр, было выяснено, что средний размер страницы игры 40 МБ. Следовательно, 232 * 40 = 9.2ГБ/сек = 74.24 Гб/сек.

**Покупка игры**: При покупке игры, происходит 4 запроса, каждый из которых за разными страницами, но они не содержат много изображений и каждая из них весит около 10 МБ. Поэтому суммарный трафик будет 4 * 10 * 66 = 21.12 Гб/сек. Банковский трафик не учтён.

**Внутриигровые микротранзакции**: 
Одна страница торговой площадки весит около 500КБ, офомрление заказа ещё 1 МБ, расчитаем трафик 11 / 0.06 * 0.5 + 1 * 22 = 205 МБ/сек = 1.6 Гб/сек

**Рейтинг** Загружается вместе со страницей карточки игры. Оценивание игры не несёт существенной нагрузки на трафик. 

### Итого

Примем пиковый трафик, равным увеличенному в два раза среднему.

#### Трафик

| Запрос                                     | Потребляемый трафик (средний) | Потребляемый трафик (пиковый) |
|--------------------------------------------|-------------------------------|-------------------------------|
| Скачивание игр                             | 1.6 Тб/сек                    | 3.2 Тб/сек                    |
| Посещение страницы игры                    | 74.24 Гб/сек                  | 1.5 Тб/сек                    |
| Покупка игр                                | 21.12 Гб/сек                  | 42.44 Гб/сек                  |
| Микротранзакции в играх, покупки и продажи | 1.6 Гб/сек                    | 3.2 Гб/сек                    |
| Рейтинг, просмотр и  оценивание            | вместе со страницей игры      | вместе со страницей игры      |

#### RPS

Примем пиковый RPS, равным увеличенному в два раза среднему.

| Запрос                                     | RPS (средний) | RPS (пиковый) |
|--------------------------------------------|---------------|---------------|
| Скачивание игр                             | 13            | 26            |
| Посещение страницы игры                    | 232           | 464           |
| Покупка игр                                | 66            | 132           |
| Микротранзакции в играх, покупки и продажи | 250           | 500           |
| Рейтинг, просмотр и  оценивание            | 220           | 440           |

## Глобальная балансировка нагрузки

Расположение датацентров будем определять количечеством трафика в различных географических точках, опираясь на предыдущий пункт и  [следующий официальный источник](https://store.steampowered.com/stats/content/).

- На Восточную Азию приходится 35% всего трафика Steam, причём 26.8% из них на Китай
- На Северную Америку приходится 22,4% всего трафика Steam, причём 19.3% из них на США
- Россия, Турция, Казахстан и Украина занимаю 8.5% всего трафика Steam, причём 6.3% из них занимает Россия
- На Европу приходится 20% всего трафика Steam
- На Южную и Центральную Америки приходится 6% всего трафика Steam, причём 3.4% из них занимает Бразилия
- На Австралию и Океанию приходится 3.5% трафика всего Steam, причём 1.4% из них занимает Австралия

Оставшийся трафик распределён по Африке, Центральной Азии и Ближнему Востоку.

Было решено распределить ДЦ следующим образом:

| Регион              | Процент трафика | Процент ДЦ |
|---------------------|-----------------|------------|
| Азия                | 35              | 45         |
| Северная Америка    | 22.4            | 30         |
| Европа              | 20              | 15         |
| Южная Америка       | 6               | 6          |
| Австралия и Океания | 3.5             | 4          |

Россия, Турция и страны СНГ будут распределены между датацентрами Европы и Азии, в зависимости от того, к какому датацентру ближе находится пользователь.

Для загрузки страницы игры задержка критична, поэтому было решено распределить датацентры пропорционально трафику, агрегированному по географическим регионам.

Для скачивания файлов игр, и совершения транзакций задержка не критична.

Для определения региона датацентра будет использоваться "Latency-based DNS" 

Внутри самого региона будет использоваться "BGP Anycast"

Регулировку можно оптимизировать, отправляя данные по протоколу QUIC, вместо обычного HTTP 1.1